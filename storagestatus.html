<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EVMC: EVM Storage Change Status</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">EVMC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('storagestatus.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">EVM Storage Change Status </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_docs_EVM_Storage_Change_Status"></a> The description of <a class="el" href="group__EVMC.html#gae012fd6b8e5c23806b507c2d3e9fb1aa" title="The effect of an attempt to modify a contract storage item.">evmc_storage_status</a> enum design and its relation to the specification in <a href="https://eips.ethereum.org/EIPS/eip-2200">EIP-2200</a> and others.</p>
<h1><a class="anchor" id="autotoc_md0"></a>
Specification</h1>
<blockquote class="doxtable">
<p>&zwj;This is the <a href="https://eips.ethereum.org/EIPS/eip-2200">EIP-2200</a> specification with modifications:</p><ul>
<li>the clause tree has been converted to ordered lists to be referenceable,</li>
<li>the cost constant names has been replaced with matching Yellow Paper names. </li>
</ul>
</blockquote>
<ol type="1">
<li>If <em>gasleft</em> is less than or equal to gas stipend, fail the current call frame with 'out of gas' exception.</li>
<li>If <em>current value</em> equals <em>new value</em> (this is a no-op), G<sub>warmaccess</sub> is deducted.</li>
<li>If <em>current value</em> does not equal <em>new value</em><ol type="a">
<li>If <em>original value</em> equals <em>current value</em> (this storage slot has not been changed by the current execution context)<ol type="i">
<li>If <em>original value</em> is 0, G<sub>sset</sub> is deducted.</li>
<li>Otherwise, G<sub>sreset</sub> gas is deducted.<ol type="A">
<li>If <em>new value</em> is 0, add R<sub>sclear</sub> gas to refund counter.</li>
</ol>
</li>
</ol>
</li>
<li>If <em>original value</em> does not equal <em>current value</em> (this storage slot is dirty), G<sub>warmaccess</sub> gas is deducted. Apply both of the following clauses.<ol type="i">
<li>If <em>original value</em> is not 0<ol type="A">
<li>If <em>current value</em> is 0 (also means that <em>new value</em> is not 0), remove R<sub>sclear</sub> gas from refund counter.</li>
<li>If <em>new value</em> is 0 (also means that <em>current value</em> is not 0), add R<sub>sclear</sub> gas to refund counter.</li>
</ol>
</li>
<li>If <em>original value</em> equals <em>new value</em> (this storage slot is reset)<ol type="A">
<li>If <em>original value</em> is 0, add G<sub>sset</sub> - G<sub>warmaccess</sub> to refund counter.</li>
<li>Otherwise, add G<sub>sreset</sub> - G<sub>warmaccess</sub> gas to refund counter.</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md1"></a>
Cost constants</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Yellow Paper   </th><th class="markdownTableHeadNone">EIP-2200   </th><th class="markdownTableHeadNone">EIP-2200 Value   </th><th class="markdownTableHeadNone">EIP-2929 Value    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">G<sub>warmaccess</sub>   </td><td class="markdownTableBodyNone"><code>SLOAD_GAS</code>   </td><td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">100    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">G<sub>sset</sub>   </td><td class="markdownTableBodyNone"><code>SSTORE_SET_GAS</code>   </td><td class="markdownTableBodyNone">20000   </td><td class="markdownTableBodyNone">20000    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">G<sub>sreset</sub>   </td><td class="markdownTableBodyNone"><code>SSTORE_RESET_GAS</code>   </td><td class="markdownTableBodyNone">5000   </td><td class="markdownTableBodyNone">2900    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">R<sub>sclear</sub>   </td><td class="markdownTableBodyNone"><code>SSTORE_CLEARS_SCHEDULE</code>   </td><td class="markdownTableBodyNone">15000   </td><td class="markdownTableBodyNone">15000   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md2"></a>
Storage change statuses</h1>
<ul>
<li><code>0</code> - zero value</li>
<li><code>X</code> - non-zero value</li>
<li><code>Y</code> - non-zero value different from <code>X</code></li>
<li><code>Z</code> - non-zero value different form <code>X</code> and <code>Y</code></li>
<li><code>o</code> - original value</li>
<li><code>c</code> - current value</li>
<li><code>v</code> - new value</li>
</ul>
<table class="doxtable">
<tr>
<th>name </th><th>o </th><th>c </th><th>v </th><th>dirty </th><th>restored </th><th>clause </th><th>gas cost </th><th>gas refund  </th></tr>
<tr>
<td rowspan="7"><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaad073aa65057b9bc304b9e723e6b7cfaa">ASSIGNED</a> </td><td>0</td><td>0</td><td>0 </td><td>no </td><td>yes </td><td>2 </td><td rowspan="7">G<sub>warmaccess</sub> </td><td rowspan="7">0  </td></tr>
<tr>
<td>X</td><td>0</td><td>0 </td><td>yes </td><td>no </td><td>2  </td></tr>
<tr>
<td>0</td><td>Y</td><td>Y </td><td>yes </td><td>no </td><td>2  </td></tr>
<tr>
<td>X</td><td>Y</td><td>Y </td><td>yes </td><td>no </td><td>2  </td></tr>
<tr>
<td>Y</td><td>Y</td><td>Y </td><td>no </td><td>yes </td><td>2  </td></tr>
<tr>
<td>0</td><td>Y</td><td>Z </td><td>yes </td><td>no </td><td>3.2  </td></tr>
<tr>
<td>X</td><td>Y</td><td>Z </td><td>yes </td><td>no </td><td>3.2  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa8afd1741edf799d44264654d9f04a5a9">ADDED</a> </td><td>0</td><td>0</td><td>Z </td><td>no </td><td>no </td><td>3.1.1 </td><td>G<sub>sset</sub> </td><td>0  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaae5b6ea5ec988f3b3ceb323ce3c0fa53f">DELETED</a> </td><td>X</td><td>X</td><td>0 </td><td>no </td><td>no </td><td>3.1.2.1 </td><td>G<sub>sreset</sub> </td><td>R<sub>sclear</sub>  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaaf102ce749767d5277923c221089da2c6">MODIFIED</a> </td><td>X</td><td>X</td><td>Z </td><td>no </td><td>no </td><td>3.1.2 </td><td>G<sub>sreset</sub> </td><td>0  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaaecee2e651cdfa14f1686903b10796b8a">DELETED_ADDED</a> </td><td>X</td><td>0</td><td>Z </td><td>yes </td><td>no </td><td>3.2.1.1 </td><td>G<sub>warmaccess</sub> </td><td>-R<sub>sclear</sub>  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa9def8aed9b4498385904ea37fad8a228">MODIFIED_DELETED</a> </td><td>X</td><td>Y</td><td>0 </td><td>yes </td><td>no </td><td>3.2.1.2 </td><td>G<sub>warmaccess</sub> </td><td>R<sub>sclear</sub>  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa88a893f304c7d0c0bbf6c82254544e28">DELETED_RESTORED</a> </td><td>X</td><td>0</td><td>X </td><td>yes </td><td>yes </td><td>3.2.1.1 + 3.2.2.2 </td><td>G<sub>warmaccess</sub> </td><td>-R<sub>sclear</sub> + G<sub>sreset</sub> - G<sub>warmaccess</sub>  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa095d061ef441491e494b124582bd1e2e">ADDED_DELETED</a> </td><td>0</td><td>Y</td><td>0 </td><td>yes </td><td>yes </td><td>3.2.2.1 </td><td>G<sub>warmaccess</sub> </td><td>G<sub>sset</sub> - G<sub>warmaccess</sub>  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa7dddf323f6fe21b15dfec07740e8038e">MODIFIED_RESTORED</a> </td><td>X</td><td>Y</td><td>X </td><td>yes </td><td>yes </td><td>3.2.2.2 </td><td>G<sub>warmaccess</sub> </td><td>G<sub>sreset</sub> - G<sub>warmaccess</sub>  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md3"></a>
Efficient implementation</h1>
<p>All distinctive storage change statuses can be unambiguously selected by combination of the 4 following checks:</p><ul>
<li><b>o ≠ c</b>, i.e. <code>original != current</code> (dirty),</li>
<li><b>o = v</b>, i.e <code>original == new</code> (restored),</li>
<li><b>c ≠ 0</b>, i.e <code>current != 0</code>,</li>
<li><b>v ≠ 0</b>, i.e <code>new != 0</code>.</li>
</ul>
<table class="doxtable">
<tr>
<th>name </th><th>o </th><th>c </th><th>v </th><th>o ≠ c </th><th>o = v </th><th>c ≠ 0 </th><th>v ≠ 0 </th><th>checksum </th><th>proof  </th></tr>
<tr>
<td rowspan="7"><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaad073aa65057b9bc304b9e723e6b7cfaa">ASSIGNED</a> </td><td>0</td><td>0</td><td>0 </td><td>0</td><td>1</td><td>0</td><td>0 </td><td>4 (0b0100)  </td></tr>
<tr>
<td>X</td><td>0</td><td>0 </td><td>1</td><td>0</td><td>0</td><td>0 </td><td>8 (0b1000)  </td></tr>
<tr>
<td>0</td><td>Y</td><td>Y </td><td>1</td><td>0</td><td>1</td><td>1 </td><td>11 (0b1011)  </td></tr>
<tr>
<td>X</td><td>Y</td><td>Y </td><td>1</td><td>0</td><td>1</td><td>1 </td><td>11 (0b1011)  </td></tr>
<tr>
<td>Y</td><td>Y</td><td>Y </td><td>0</td><td>1</td><td>1</td><td>1 </td><td>7 (0b0111)  </td></tr>
<tr>
<td>0</td><td>Y</td><td>Z </td><td>1</td><td>0</td><td>1</td><td>1 </td><td>11 (0b1011)  </td></tr>
<tr>
<td>X</td><td>Y</td><td>Z </td><td>1</td><td>0</td><td>1</td><td>1 </td><td>11 (0b1011)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa8afd1741edf799d44264654d9f04a5a9">ADDED</a> </td><td>0</td><td>0</td><td>Z </td><td>0</td><td>0</td><td>0</td><td>1 </td><td>1 (0b0001)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaae5b6ea5ec988f3b3ceb323ce3c0fa53f">DELETED</a> </td><td>X</td><td>X</td><td>0 </td><td>0</td><td>0</td><td>1</td><td>0 </td><td>2 (0b0010)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaaf102ce749767d5277923c221089da2c6">MODIFIED</a> </td><td>X</td><td>X</td><td>Z </td><td>0</td><td>0</td><td>1</td><td>1 </td><td>3 (0b0011)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaaecee2e651cdfa14f1686903b10796b8a">DELETED_ADDED</a> </td><td>X</td><td>0</td><td>Z </td><td>1</td><td>0</td><td>0</td><td>1 </td><td>9 (0b1001)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa9def8aed9b4498385904ea37fad8a228">MODIFIED_DELETED</a> </td><td>X</td><td>Y</td><td>0 </td><td>1</td><td>0</td><td>1</td><td>0 </td><td>10 (0b1010)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa88a893f304c7d0c0bbf6c82254544e28">DELETED_RESTORED</a> </td><td>X</td><td>0</td><td>X </td><td>1</td><td>1</td><td>0</td><td>1 </td><td>13 (0b1101)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa095d061ef441491e494b124582bd1e2e">ADDED_DELETED</a> </td><td>0</td><td>Y</td><td>0 </td><td>1</td><td>1</td><td>1</td><td>0 </td><td>14 (0b1110)  </td></tr>
<tr>
<td><a class="el" href="group__EVMC.html#ggae012fd6b8e5c23806b507c2d3e9fb1aaa7dddf323f6fe21b15dfec07740e8038e">MODIFIED_RESTORED</a> </td><td>X</td><td>Y</td><td>X </td><td>1</td><td>1</td><td>1</td><td>1 </td><td>15 (0b1111)  </td></tr>
<tr>
<td rowspan="4">impossible </td><td></td><td></td><td></td><td>0</td><td>0</td><td>0</td><td>0 </td><td>0 (0b0000) </td><td>o=c ∧ o≠v ∧ c=0 ⇒ v≠0  </td></tr>
<tr>
<td></td><td></td><td></td><td>0</td><td>1</td><td>0</td><td>1 </td><td>5 (0b0101) </td><td>o=c ∧ o=v ∧ c=0 ⇒ v=0  </td></tr>
<tr>
<td></td><td></td><td></td><td>0</td><td>1</td><td>1</td><td>0 </td><td>6 (0b0110) </td><td>o=c ∧ o=v ∧ c≠0 ⇒ v≠0  </td></tr>
<tr>
<td></td><td></td><td></td><td>1</td><td>1</td><td>0</td><td>0 </td><td>12 (0b1100) </td><td>o≠c ∧ o=v ∧ c=0 ⇒ v≠0  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Feb 7 2025 11:58:08 for EVMC by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
